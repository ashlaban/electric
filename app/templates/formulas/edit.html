{% extends "base.html" %}

{% block title %}Edit Formula - Electric{% endblock %}

{% block content %}
<hgroup>
    <h1>Edit Cost Formula</h1>
    <p>{{ property.display_name }} &mdash; {{ formula.name }}</p>
</hgroup>

<article>
    <form method="post" action="/formulas/{{ formula.id }}/edit" id="formula-form">
        <label for="name">
            Formula Name
            <input type="text" id="name" name="name" value="{{ formula.name }}" required>
        </label>

        <label for="description">
            Description / Location (optional)
            <input type="text" id="description" name="description"
                   value="{{ formula.description or '' }}"
                   placeholder="e.g. Apartment 2B, second floor">
        </label>

        <hr>

        <p><strong>Terms</strong></p>
        <p><small>Each term maps a meter to a coefficient. The formula computes:<br>
            cost = total_bill &times; sum(coefficient &times; meter_consumption) / main_meter_consumption</small></p>

        <div id="terms-container">
            {% for meter_name, coeff in formula.terms.items() %}
                <div class="term-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                    <select name="term_meter_{{ loop.index0 }}" style="flex: 2" required>
                        <option value="">Select meter...</option>
                        {% for meter in meters %}
                            {% if meter.meter_type.value != 'main_meter' %}
                                <option value="{{ meter.name }}"
                                        {% if meter.name == meter_name %}selected{% endif %}>
                                    {{ meter.name }}{% if meter.location %} ({{ meter.location }}){% endif %}
                                </option>
                            {% endif %}
                        {% endfor %}
                        <option value="_unmetered" {% if meter_name == "_unmetered" %}selected{% endif %}>
                            Unmetered (common area)
                        </option>
                    </select>
                    <input type="number" name="term_coeff_{{ loop.index0 }}" step="0.01" min="0"
                           value="{{ coeff }}" style="flex: 1" required>
                    {% if not loop.first %}
                        <button type="button" class="outline secondary"
                                style="padding: 0.25rem 0.5rem; margin: 0; flex-shrink: 0;"
                                onclick="this.parentElement.remove()">
                            &times;
                        </button>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        <button type="button" class="outline" onclick="addTerm()" style="margin-bottom: 1rem">
            + Add Term
        </button>

        <button type="submit">Save Changes</button>
    </form>
</article>

<p><a href="/formulas?property_id={{ property_id }}">&larr; Back to Formulas</a></p>
{% endblock %}

{% block scripts %}
<script>
let termCount = {{ formula.terms | length }};

function addTerm() {
    const container = document.getElementById('terms-container');
    const row = document.createElement('div');
    row.className = 'term-row';
    row.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';

    const firstSelect = document.querySelector('select[name="term_meter_0"]');
    const newSelect = firstSelect.cloneNode(true);
    newSelect.name = `term_meter_${termCount}`;
    newSelect.value = '';
    newSelect.style.flex = '2';

    const input = document.createElement('input');
    input.type = 'number';
    input.name = `term_coeff_${termCount}`;
    input.step = '0.01';
    input.min = '0';
    input.placeholder = 'Coefficient';
    input.value = '1.0';
    input.style.flex = '1';
    input.required = true;

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = '\u00d7';
    removeBtn.className = 'outline secondary';
    removeBtn.style.cssText = 'padding: 0.25rem 0.5rem; margin: 0; flex-shrink: 0;';
    removeBtn.onclick = function() { row.remove(); };

    row.appendChild(newSelect);
    row.appendChild(input);
    row.appendChild(removeBtn);
    container.appendChild(row);
    termCount++;
}
</script>
{% endblock %}
